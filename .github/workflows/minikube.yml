name: deploy minikube
on:
  workflow_dispatch:
  push:
    paths: 
      - infra/k8s/**
      - skaffold.yaml
      - .github/workflows/minikube.yml
  
jobs:
  deploy_minikube:
    name: Deploy Minikube
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Start minikube
        uses: medyagh/setup-minikube@master
      
      - name: Setup SSH Known Hosts
        run: |
          mkdir -p -m 0755 ~/.ssh
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Setup k8s
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          sudo install skaffold /usr/local/bin/
          skaffold run -v warn
          
      - name: Run ese API test
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          export URL=$(minikube service api --url) 
          postman collection run 28977325-d9e66c38-9472-46a8-b41c-16cf3b02a912 \
            -e 28977325-6493092b-46e6-4de5-a4c2-d7a72add3afe \
            --env-var "url=$URL" \
            -i 28977325-1044f8ee-1372-498b-bc38-8f0dec00291f \
            -i 28977325-9ec3a1bb-1bfc-4f92-a099-b108621bac7e \
            -i 28977325-1ae6d742-c1b5-4d8a-92ab-e7dede36e9dc
          postman collection run 28977325-d9e66c38-9472-46a8-b41c-16cf3b02a912 \
            -e 28977325-6493092b-46e6-4de5-a4c2-d7a72add3afe \
            --env-var "url=$URL"